{% extends 'base.html' %}

{% block title %}{{ lesson.title }} – {{ app_name }}{% endblock %}

{% block head %}
<style>
   .lesson-container {
    max-width: 900px;
    margin: 0 auto;
    padding: var(--space-8) var(--space-6);
   }

   .lesson-header {
    background: linear-gradient(135deg, var(--success-50) 0%, var(--success-100) 100%);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    margin-bottom: var(--space-8);
    border: 1px solid var(--success-200);
    position: relative;
    overflow: hidden;
   }

   .lesson-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--success-500), var(--success-600));
   }

   .lesson-title {
    font-size: 2.25rem;
    font-weight: 700;
    color: var(--gray-900);
    margin-bottom: var(--space-4);
    line-height: 1.2;
   }

   .lesson-meta {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-6);
    margin-bottom: var(--space-6);
   }

   .meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--gray-600);
    font-size: 0.95rem;
   }

   .meta-icon {
    color: var(--success-500);
    font-size: 1.1rem;
   }

   .meta-label {
    font-weight: 600;
    color: var(--gray-700);
   }

   .tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-top: var(--space-2);
   }

   .tag {
    background: var(--success-100);
    color: var(--success-700);
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.8rem;
    font-weight: 500;
    border: 1px solid var(--success-200);
   }

   .lesson-summary {
    background: var(--warning-50);
    border: 1px solid var(--warning-200);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    margin-bottom: var(--space-8);
    border-left: 4px solid var(--warning-500);
   }

   .summary-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
   }

   .summary-icon {
    background: var(--warning-100);
    color: var(--warning-600);
    padding: var(--space-2);
    border-radius: var(--radius-md);
    font-size: 1.1rem;
   }

   .summary-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
   }

   .summary-text {
    font-size: 1.05rem;
    line-height: 1.6;
    color: var(--gray-700);
   }

   .lesson-content {
    background: white;
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-200);
    margin-bottom: var(--space-8);
   }

   .content-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-4);
    border-bottom: 2px solid var(--gray-100);
   }

   .content-icon {
    background: var(--success-100);
    color: var(--success-600);
    padding: var(--space-3);
    border-radius: var(--radius-lg);
    font-size: 1.25rem;
   }

   .content-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--gray-900);
    margin: 0;
   }

   .lesson-text {
    font-size: 1.1rem;
    line-height: 1.7;
    color: var(--gray-700);
    white-space: pre-wrap;
   }

   .lesson-actions {
    display: flex;
    gap: var(--space-4);
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
   }

   .action-group {
    display: flex;
    gap: var(--space-3);
   }

   .btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-5);
    border-radius: var(--radius-lg);
    font-weight: 500;
    text-decoration: none;
    transition: all var(--transition-normal);
    border: none;
    cursor: pointer;
    font-size: 0.95rem;
   }

   .btn-primary {
    background: linear-gradient(135deg, var(--success-600), var(--success-700));
    color: white;
    box-shadow: var(--shadow-md);
   }

   .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
   }

   .btn-secondary {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 1px solid var(--gray-300);
   }

   .btn-secondary:hover {
    background: var(--gray-200);
    transform: translateY(-1px);
   }

   .btn-danger {
    background: var(--error-600);
    color: white;
   }

   .btn-danger:hover {
    background: var(--error-700);
    transform: translateY(-1px);
   }

   .timestamps {
    color: var(--gray-500);
    font-size: 0.9rem;
   }

   .btn-success {
    background: var(--success-500);
    color: white;
   }

   .btn-success:hover {
    background: var(--success-600);
    transform: translateY(-1px);
   }

   @media (max-width: 768px) {
    .lesson-container {
      padding: var(--space-6) var(--space-4);
    }

    .lesson-header {
      padding: var(--space-6);
    }

    .lesson-title {
      font-size: 1.75rem;
    }

    .lesson-meta {
      flex-direction: column;
      gap: var(--space-3);
    }

    .lesson-content {
      padding: var(--space-6);
    }

    .lesson-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .action-group {
      justify-content: center;
    }
  }

  /* Toast notification styles */
  .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    max-width: 400px;
  }

  .toast-notification {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--gray-200);
    margin-bottom: var(--space-3);
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
    overflow: hidden;
  }

  .toast-notification.show {
    opacity: 1;
    transform: translateX(0);
  }

  .toast-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3) var(--space-4);
    background: var(--gray-50);
    border-bottom: 1px solid var(--gray-200);
  }

  .toast-body {
    padding: var(--space-3) var(--space-4);
    color: var(--gray-700);
  }

  .toast-close {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    color: var(--gray-500);
    padding: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .toast-close:hover {
    color: var(--gray-700);
  }

  /* Toast type specific styles */
  .toast-success .toast-header {
    background: var(--success-50);
    border-bottom-color: var(--success-200);
  }

  .toast-success .toast-header strong {
    color: var(--success-700);
  }

  .toast-error .toast-header {
    background: var(--error-50);
    border-bottom-color: var(--error-200);
  }

  .toast-error .toast-header strong {
    color: var(--error-700);
  }

  .toast-warning .toast-header {
    background: var(--warning-50);
    border-bottom-color: var(--warning-200);
  }

  .toast-warning .toast-header strong {
    color: var(--warning-700);
  }

  .toast-info .toast-header {
    background: var(--info-50);
    border-bottom-color: var(--info-200);
  }

  .toast-info .toast-header strong {
    color: var(--info-700);
  }
</style>
{% endblock %}

{% block scripts %}
<script>
// Function to mark a lesson as read
function markLessonAsRead(lessonId, buttonElement) {
    console.log('Mark as read clicked for lesson:', lessonId);

    // Check if user is authenticated
    const isAuthenticated = {{ 'true' if current_user.is_authenticated else 'false' }};

    if (!isAuthenticated) {
        showToast('Please log in to mark lessons as read.', 'warning');
        return;
    }

    // Disable button to prevent double-clicks
    buttonElement.disabled = true;
    const originalHTML = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Marking...</span>';

    // Send request to mark as read
    fetch(`/api/mark-lesson-read/${lessonId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            lesson_id: lessonId
        })
    })
    .then(response => {
        console.log('API response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('API response data:', data);

        if (data.success) {
            // Update button appearance
            buttonElement.classList.remove('btn-secondary');
            buttonElement.classList.add('btn-success');
            buttonElement.innerHTML = '<i class="fas fa-check-circle"></i> <span>Read</span>';
            buttonElement.disabled = true;

            // Show success message
            showToast('Lesson marked as read successfully!', 'success');
        } else if (data.already_read) {
            // Already read - update button appearance
            buttonElement.classList.remove('btn-secondary');
            buttonElement.classList.add('btn-success');
            buttonElement.innerHTML = '<i class="fas fa-check-circle"></i> <span>Read</span>';
            buttonElement.disabled = true;

            // Show info message
            showToast('This lesson was already marked as read.', 'info');
        } else {
            // Re-enable button on error
            buttonElement.disabled = false;
            buttonElement.innerHTML = originalHTML;

            // Show error message
            showToast(data.message || 'Failed to mark lesson as read.', 'error');
        }
    })
    .catch(error => {
        console.error('Error marking lesson as read:', error);

        // Re-enable button on error
        buttonElement.disabled = false;
        buttonElement.innerHTML = originalHTML;

        // Show error message
        showToast('Network error. Please try again.', 'error');
    });
}

// Toast notification function
function showToast(message, type = 'info') {
    console.log('Showing toast:', message, type);

    // Create toast container if it doesn't exist
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }

    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;

    // Determine icon and title based on type
    const typeConfig = {
        'success': { icon: '✓', title: 'Success' },
        'error': { icon: '✕', title: 'Error' },
        'warning': { icon: '⚠', title: 'Warning' },
        'info': { icon: 'ℹ', title: 'Info' }
    };

    const config = typeConfig[type] || typeConfig['info'];

    toast.innerHTML = `
        <div class="toast-header">
            <strong>${config.title}</strong>
            <button class="toast-close" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
        <div class="toast-body">${message}</div>
    `;

    // Add to container
    container.appendChild(toast);

    // Show toast
    setTimeout(() => {
        toast.classList.add('show');
        console.log('Toast shown');
    }, 100);

    // Auto-hide after 4 seconds for better visibility
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
                console.log('Toast removed');
            }
        }, 300);
    }, 4000);
}

// Initialize read status when page loads
document.addEventListener('DOMContentLoaded', function() {
    {% if current_user.is_authenticated %}
    // Check read status for this lesson
    checkLessonReadStatus({{ lesson.id }});
    {% endif %}
});

// Function to check if a lesson has been read
function checkLessonReadStatus(lessonId) {
    fetch(`/api/check-lesson-read/${lessonId}`)
    .then(response => response.json())
    .then(data => {
        if (data.read) {
            const button = document.getElementById('mark-read-btn');
            if (button) {
                button.classList.remove('btn-secondary');
                button.classList.add('btn-success');
                button.innerHTML = '<i class="fas fa-check-circle"></i> <span>Read</span>';
                button.disabled = true;
            }
        }
    })
    .catch(error => {
        console.error('Error checking lesson read status:', error);
    });
}
</script>
{% endblock %}

{% block content %}
<div class="lesson-container">
  <!-- Header Section -->
  <div class="lesson-header">
    <h1 class="lesson-title">{{ lesson.title }}</h1>

    <div class="lesson-meta">
      <div class="meta-item">
        <i class="fas fa-user meta-icon"></i>
        <span class="meta-label">Author:</span>
        <span>{{ lesson.author or 'Unknown' }}</span>
      </div>

      <div class="meta-item">
        <i class="fas fa-building meta-icon"></i>
        <span class="meta-label">Department:</span>
        <span>{{ lesson.department or 'Not specified' }}</span>
      </div>

      <div class="meta-item">
        <i class="fas fa-calendar-alt meta-icon"></i>
        <span class="meta-label">Created:</span>
        <span>
          {% if lesson.created_at %}
            {{ lesson.created_at.strftime('%B %d, %Y') }}
          {% else %}
            Date unknown
          {% endif %}
        </span>
      </div>

      {% if lesson.tags %}
      <div class="meta-item">
        <i class="fas fa-tags meta-icon"></i>
        <span class="meta-label">Tags:</span>
        <div class="tags-container">
          {% for tag in lesson.tags %}
            <span class="tag">{{ tag }}</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Summary Section -->
  {% if lesson.summary %}
  <div class="lesson-summary">
    <div class="summary-header">
      <div class="summary-icon">
        <i class="fas fa-lightbulb"></i>
      </div>
      <h2 class="summary-title">Key Takeaway</h2>
    </div>
    <div class="summary-text">{{ lesson.summary | safe }}</div>
  </div>
  {% endif %}

  <!-- Content Section -->
  <div class="lesson-content">
    <div class="content-header">
      <div class="content-icon">
        <i class="fas fa-book-open"></i>
      </div>
      <h2 class="content-title">Detailed Lesson</h2>
    </div>

    <div class="lesson-text">{{ lesson.content | safe }}</div>
  </div>

  <!-- Actions Section -->
  <div class="lesson-actions">
    <div class="action-group">
      <a href="{{ url_for('list_lessons_learned') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i>
        Back to Lessons
      </a>

      {% if current_user.is_authenticated %}
        <button id="mark-read-btn" class="btn btn-secondary" onclick="markLessonAsRead({{ lesson.id }}, this)">
          <i class="fas fa-check"></i>
          <span>Mark as Read</span>
        </button>

        {% if user_role.is_admin %}
        <a href="{{ url_for('edit_lesson_learned', lesson_id=lesson.id) }}" class="btn btn-primary">
          <i class="fas fa-edit"></i>
          Edit Lesson
        </a>

        <form action="{{ url_for('delete_lesson_learned', lesson_id=lesson.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this lesson? This action cannot be undone.');">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash-alt"></i>
            Delete
          </button>
        </form>
        {% endif %}
      {% endif %}
    </div>

    <div class="timestamps">
      {% if lesson.updated_at and lesson.updated_at != lesson.created_at %}
        Last updated: {{ lesson.updated_at.strftime('%B %d, %Y') }}
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
